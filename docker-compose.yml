x-common: &common
  build:
    context: .
    dockerfile: Dockerfile
    target: qgis-only
  volumes:
    - /tmp/.X11-unix:/tmp/.X11-unix
    - ./src/:/src/
  environment:
    - "DISPLAY=${DISPLAY}"
    - QT_QPA_PLATFORM=offscreen

x-without-cleanup: &without-cleanup
  command: 'python3 src/test_without_cleanup.py'

x-conda-without-cleanup: &conda-without-cleanup
  command: './src/run_in_conda.sh python3 src/test_without_cleanup.py'


version: '3.4'
services:

  official_env_with_cleanup:
    <<: *common


  official_env_without_cleanup:
    <<: [*common, *without-cleanup]


  official_env_conda_installed_with_cleanup: &official-plus-conda
    <<: *common
    build:
      context: .
      dockerfile: Dockerfile
      target: qgis-plus-conda


  official_env_conda_installed_without_cleanup:
    <<: [*official-plus-conda, *without-cleanup]


  conda_env_with_cleanup: &conda
    <<: *common
    build:
      context: .
      dockerfile: Dockerfile
      target: qgis-in-conda-env


  conda_env_without_cleanup:
    <<: [*conda, *conda-without-cleanup]
